<?php
mb_http_input("iso-8859-1");
mb_http_output("iso-8859-1");
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>TbsSQL - documentation</title>
<style type="text/css">
<!--
body, td, th {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 11px;
}
.sql {
	font-family: "Courier New", Courier, mono;
	color: #006600;
}
.decal {
	margin-left: 20px;
}
h1 {
	font-size: 18px;
	font-weight: bold;
}
h2 {
	font-size: 13px;
	font-weight: bold;
}
h3 {
	text-decoration: underline;
	font-weight: normal;
	font-size: 12px;
}
.versioning {
	background-color: #EAEAEA;
}
.split {
	border-bottom-width: 1px;
	border-bottom-style: dotted;
	border-bottom-color: #069;
}
.split0 {
	border-top-width: 1px;
	border-top-style: dotted;
	border-top-color: #069;
}
-->
</style>
</head>

<body>
<table width="100%" border="0" cellspacing="0" cellpadding="3">
  <tr>
    <td width="200"><a href="http://www.tinybutstrong.com">Skrol29</a>, 2010-06-16 </td>
    <td><h1 align="center">TbsSQL 3.0</h1></td>
    <td width="200">&nbsp;</td>
  </tr>
</table>
<hr />
The goal of TbsSQL is to reduce the code when working with SQL through PHP. It is called a SQL abstraction tool. The TbsSQL is available for the following databases:<br />
<div class="decal">- MySQL<br />
  - MySQLi<br />
  - SQL-Server (via Ms ODBC or UnixODBC)<br />
  - PostgreSQL (version 7.2 or higher) <br />
  - ODBC Generic (<span class="versioning">available since TbsSQL version 2.6</span>) </div>
<h2>&bull; Coding</h2>
<div class="decal"> The main asset of TbsSQL is the habitably  to merge in the SQL statement a variable number of arguments and protect them against <a href="http://en.wikipedia.org/wiki/Sql_injection">Sql Injection</a>.<br />
  <br />
  <u>Example:</u> <br />
  <div class="decal"><span class="sql">$id = 29;<br />
    $name = &quot;boby&quot;; <br />
    $Db-&gt;Execute('UPDATE table1 SET name=@2@ WHERE (id=%1%)', $id, $name);</span><br />
    In this example, the SQL statement sent to the database will be: <span class="sql">UPDATE table1 SET name='boby' WHERE (id=29)</span></div>
  <br />
  TbsSQL supports the following jokers  in your SQL statements:<br />
  &nbsp;&nbsp;&nbsp;&nbsp;(n must be the number of the place of the argument in the TbsSQL command)<br />
  <table width="100%" border="0" cellspacing="0" cellpadding="3">
    <tr>
      <td width="10">-</td>
      <td width="40">%n%</td>
      <td>The argument will be protected against Sql Injection. Example: %1%</td>
    </tr>
    <tr>
      <td>-</td>
      <td>@n@ </td>
      <td>The argument will be protected against Sql Injection and delimited as a string value with the relevant format for the database. Example: @1@</td>
    </tr>
    <tr>
      <td>-</td>
      <td>#n#</td>
      <td>The argument will be converted as a date value without time with the relevant format for the database. Example: #1#</td>
    </tr>
    <tr>
      <td>-</td>
      <td>~n~ </td>
      <td>The argument will be converted as a date and time value with the relevant format for the database. Example: ~1~</td>
    </tr>
  </table>
  <br />
  <u>Managing NULL values:</u><br />
  You can also use jokers %[n]% , @[n]@ , 
  #[n]# and ~[n]~ to replace the value by the SQL keyword 'NULL' when the value to merge is the PHP value {false} or {null}. Please note that empty string {''} will not be replaced with the SQL keyword 'NULL'.<br />
  Example:<br />
  <div class="decal"><span class="sql">$id = 29;<br />
    $date = false; <br />
    $Db-&gt;Execute('UPDATE table1 SET fd=[#2#] WHERE (id=%1%)', $id, $date);</span><br />
    In this example, the SQL statement sent to the database will be: <span class="sql">UPDATE table1 SET fd=NULL WHERE (id=29)</span></div>
  <div class="versioning">Versioning: Jokers for nullable values are supported since TbsSQL version 2.5.</div>
</div>
<h2>&bull; Hook</h2>
<div class="decal"> TbsSQL is compatible with the <a href="http://www.tinybutstrong.com">TinyButStrong</a> Template Engine.<br />
  Use the property $Db-&gt;TbsKey in order to have the MergeBlock() method using your TbsSQL instance.<br />
  Example : <span class="sql">$TBS-&gt;MergeBlock('b',$Db-&gt;TbsKey,'SELECT * FROM table1');</span><br />
  <div class="versioning">Versioning: before version 2.5, property $Db-&gt;TbsKey doesn't exist and the TBS key is the same for all TbsSQL instance. You must use the keyword 'tbssql' instead of $Db-&gt;TbsKey.</div>
</div>
<h2>&bull; License</h2>
<div class="decal"> TbsSQL is a free and open source. It is published under the LGPL license. </div>
<h2>&bull; Synopsis</h2>
  <h3>Connecting to the database</h3>
  <div class="decal">
    <table width="100%" border="0" cellspacing="0" cellpadding="4">
      <tr>
        <td width="260" valign="top" class="split0 split">$Db = new <strong>clsTbsSQL</strong>($srv='',$uid='',$pwd='',$db='',$drv='',$mode=TBSSQL_NORMAL); </td>
        <td valign="top" class="split0 split">Instantiates the class. 
          Giving connection information is optional. <br />
          <span class="versioning">Versioning: optional argument $mode is supported since TbsSQL version 2.6.</span></td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>Connect</strong>($srv,$uid,$pwd,$db,$drv='',$mode=TBSSQL_NORMAL)<br />
          &nbsp;&nbsp;or<br />
          $Db-&gt;<strong>Connect</strong>('glob_var');<br />
          <br />
          <u>Arguments:</u><br />
          $srv: server (or connection string for some database type)<br />
          $uid: user id<br />
          $db: database name<br />
          $drv: driver (optional, needed for some database type)<br />
          $mode: TbsSQL warning mode (see property Mode)</td>
        <td valign="top" class="split">Open a connection to the database.<br />
          Syntax 1 example:<br />
          <div class="decal"><span class="sql">$Db-&gt;Connect('localhost','root','xxx','db_prod');</span><br />
            The argument $drv is needed only for some Dabase Systems.</div>
          Syntax 2 example:<br />
          <div class="decal"><span class="sql">$glob_var = array('srv'=&gt;'localhost','uid'=&gt;'root','pwd'=&gt;'xxx','db'=&gt;'db_prod');<br />
            $Db-&gt;Connect('glob_var');</span><br />
            'glob_var' must be the name of a global variable beeing a PHP array with the keys described above.<br />
            The global variable is <strong>destroyed</strong> just after the connection. </div>
          <div class="versioning">Versioning: syntax2 is available since TbsSQL version 2.0. Optional argument $mode is supported since TbsSQL version 2.6.<br />
          </div>
          <u>Note:</u> You don't need to call this method if your connection has already been opened before. In this case, you just have to assign the connection id to property -&gt;Id. (example: $Db-&gt;Id = $mycn). You don't have to do this assignation when PHP can work automatically with the last opened connection. This is the case for MySQL for example.<br />
          <u>ODBC:</u> (and SQL server with ODBC)<br />
          Argument $srv can be a server name, or a connection string. You cna define a DSN (Data Source Name) using the connection string: 'DSN=my_dsn'.<br />
          Examples:<br />
          $drv	= 'my_server';<br />
          $drv = 'DSN=my_dsn'<br />
          $drv = 'DRIVER={SQL Server};SERVER=my_server'<br />
          $drv = 'Provider=Microsoft.Jet.OLEDB.4.0;Data Source=C:\mydatabase.mdb;'</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>Close</strong>()</td>
        <td valign="top" class="split">Close the current connection to the database.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>Id</strong></td>
        <td valign="top" class="split">(read/write) The resource  Id of your connection. </td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>Mode</strong></td>
        <td valign="top" class="split">(read/write) default value is TBSSQL_NORMAL.<br />
          TBSSQL_SILENT: silent mode, no database error message is displayed. <br />
          TBSSQL_NORMAL: normal mode, the database error message is displayed when an error occurs. <br />
          TBSSQL_DEBUG: debug mode, the full SQL statement is also recalled when an error occurs.<br />
          TBSSQL_TRACE: trace mode, all queries are displayed.<br />
          <div class="versioning">Versioning: the constants TBSSQL_* are supported since TbsSQL version 2.5<br />
          </div></td>
      </tr>
    </table>
  </div>
 
  <h3>Working with SQL</h3>
  <div class="decal">
    <table width="100%" border="0" cellspacing="0" cellpadding="4">
      <tr>
        <td width="260" valign="top" class="split split0">$Db-&gt;<strong>Execute</strong>($sql,...*...)</td>
        <td valign="top" class="split split0">Execute the Sql statement.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>GetVal</strong>($sql,...*...)</td>
        <td valign="top" class="split">Returns the value of the first column in the first record of the query.<br />
          If no record is returned by the query, then the function returns False.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>GetRow</strong>($sql,...*...)</td>
        <td valign="top" class="split">Returns an associative PHP array which is the first record returned by the query.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>GetRows</strong>($sql,...*...)</td>
        <td valign="top" class="split">Returns a PHP array of all records returned by the query.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>GetList</strong>($sql,...*...)</td>
        <td valign="top" class="split">Returns a PHP array with first column as keys and second column as values. If only one columns is given by the query then they the values of the array.<br />
          <div class="decal"><u>Example:</u> $Db-&gt;GetList('SELECT id,name FROM t_people');<br />
            will return something like: array(1=&gt;'Peter', 2=&gt;'Dave', 3=&gt;'Jane' ,...)</div></td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>GetSql</strong>($sql,...*...)</td>
        <td valign="top" class="split">Returns the SQL statement with merged arguments.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>LastRowId</strong>()</td>
        <td valign="top" class="split">Returns the value of the identifier generated by the last INSERT query of your connection. <br />
          <u>Note:</u> This method is not available for ODBC Generic.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>AffectedRows</strong>()</td>
        <td valign="top" class="split">Returns the number of rows affected  by the last UPDATE or DELETE query of your connection.<br />
          <u>Note:</u> This method is not available for ODBC Generic.</td>
      </tr>
    </table>
  <em>...*... means a variable number of arguments that will be merged in the SQL statement. </em></div>
 
  <h3>Using cache</h3>
  <div class="decal">
  <p>What is the TbsSQL cache feature? SQL queries results can be saved in cache files in order to save time execution when they are recalled. Cache files are available for a limited duration (timeout) in order to ensure the actualization of the data. <br />
    The TbsSQL cache feature is disabled by default. You can enable it simply by setting a positive value to property $Db-&gt;CacheTimeout.<br />
    Interesting technical notes: 
    <br />
    - 
    TbsSQL cache files cannot be read by users because they are PHP files.<br />
    - 
    The TbsSQL cache feature will never provide data from another SQL query. Other tools, like  ezSQL for example, can <span id="result_box2"><span title="">theoretically</span></span> be wrong when identifying a cache file because they are identified only by a hash value (md5). Hash values are not  unique ids, even if the probability of doubles is very poor.<br />
    - 
  When the cache is enabled, TbsSQL will (by default) automatically get rid of cache files that come from old unused queries.</p>
    <table width="100%" border="0" cellspacing="0" cellpadding="4">
      <tr>
        <td width="260" valign="top" class="split0 split">$Db-&gt;<strong>CacheTimeout</strong></td>
        <td valign="top" class="split0 split">Defines the cache timeout in minutes for all SQL queries called by methods GetVal(), GetRow(), GetRows() and GetList().        The default value is false, which means the cache feature is disabled. Method Execute() is not concerned by the cache feature.<br />
          You can use constants TBSSQL_1HOUR, 
          TBSSQL_1DAY or TBSSQL_1WEEK in order to easier define the timeout.<br />
          Use property CacheSpecialTimeout to force the cache for<span id="result_box"><span title=""> only one query, whether default cache is enabled or not.</span></span>
          <div class="decal"><u>Example:</u> $Db-&gt;CacheTimeout = 2 * TBSSQL_1DAY;<br />
          this  does enable the cache for all queries with a cache duration of one day.</div></td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>CacheSpecialTimeout</strong></td>
        <td valign="top" class="split">Define the cache timeout in minutes but only for the next query. You can use this property to active the cache for only one query, or to change the cache timeout for a only one query.<br />
          Default value is false, which means there is no special timeout for the next query.<br />
        If the cache is enabled (i.e. CacheTimeout &gt; 0), you can disable the cache only for the next query by setting CacheSpecialTimeout to TBSSQL_NOCACHE.
        <div class="decal"><u>Example:</u><br /> 
          $Db-&gt;CacheSpecialTimeout = TBSSQL_1DAY;<br />
        $x = $Db-&gt;GetRows('SELECT id, name FROM table1 ORDER BY id');<br />
        </div></td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>CacheAutoClear</strong></td>
        <td valign="top" class="split"> When the cache is enabled, TbsSQL can try to delete old cached queries in the cache directory. <br />
        The default value is TBSSQL_1WEEK.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>CacheDir</strong></td>
        <td valign="top" class="split"> This property defines the directory where cached queries are stored.<br />
        The default value is '.'.</td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>CacheSuffix</strong></td>
        <td valign="top" class="split">Default value is '' (empty string). This property enables you to add a suffix in the cache file names. You do not need it most of the time. It is designed to separate the cached results  for the same SQL queries string, for example when a project may use the same queries in  two different Databases.</td>
      </tr>
    </table>
</div>
 
  <h3>Working with TinyButStrong template engine</h3>
  <div class="decal">
    <table width="100%" border="0" cellspacing="0" cellpadding="4">
      <tr>
        <td width="260" valign="top" class="split0 split">$Db-&gt;<strong>TbsKey</strong></td>
        <td valign="top" class="split0 split">(read) Return the TinyButStrong key string for the current connection (see chapter Hook above). This property has always a default value which is unique for each new instance.<br />
          Most of the time there is no need know the value of this property,  since you can use the property directly with TBS.<br />
          Example: <span class="sql">$TBS-&gt;MergeBlock('b',$Db-&gt;TbsKey,'SELECT * FROM table1');</span> <br />
          <div class="versioning">Versioning: this property is available since TbsSQL version 2.5<br />
          </div></td>
      </tr>
      <tr>
        <td valign="top" class="split">$Db-&gt;<strong>SetTbsKey</strong>($key)</td>
        <td valign="top" class="split">Change the value of property $Db-&gt;TbsKey. Most of the time, there is no need to use this method because property TbsKey has always a default value which is unique. Use this method only if your application do need a customized key value for the TinyButStrong merging.<br />
          Example:<br />
          <div class="sql decal">$Db-&gt;SetTbsKey('myconnection');<br />
            $TBS-&gt;MergeBlock('b', 'myconnection', 'SELECT * FROM table1');</div>
          <div class="versioning">Versioning: this method is available since TbsSQL version 2.5</div></td>
      </tr>
    </table>
  </div>
</div>
<h2>&bull; Deprecated</h2>
<div class="decal">
<p>Those methods are deprecated in TbsSQL version 2.x, and unsupported since version 3.x</p>
  <table width="100%" border="0" cellspacing="0" cellpadding="3">
    <tr>
      <td width="260" valign="top">$Db-&gt;Row1($sql,...*...)</td>
      <td valign="top">Same as $Db-&gt;GetRow()</td>
    </tr>
    <tr>
      <td valign="top">$Db-&gt;Rows($sql,...*...)</td>
      <td valign="top">Same as $Db-&gt;GetRows()</td>
    </tr>
    <tr>
      <td valign="top">$Db-&gt;Value($default,$sql,...*...)</td>
      <td valign="top">Same as $Db-&gt;GetVal() but with a default value. </td>
    </tr>
  </table>
</div>
</body>
</html>
